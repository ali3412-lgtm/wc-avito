# Руководство по экспорту отладочной информации

## Назначение

Функция экспорта отладочной информации создана для быстрой диагностики проблем в плагине WC Avito XML Export. Она генерирует JSON файл со всеми настройками, данными о товарах и категориях, а также системной информацией.

## Как использовать

### 1. Экспорт данных

1. Перейдите в WordPress админ-панель
2. Откройте **WooCommerce → Avito Export**
3. Найдите секцию **"Экспорт настроек для отладки"**
4. Нажмите кнопку **"Экспортировать настройки"**
5. Появится сообщение об успешном создании файла с кнопкой **"Скачать avito-debug-YYYY-MM-DD-HH-MM-SS.json"**
6. Нажмите на кнопку для скачивания файла

**Примечание:** Файл сохраняется в директорию `wp-content/uploads/` и доступен для скачивания по прямой ссылке.

### 2. Отправка файла для анализа

Отправьте скачанный JSON файл разработчику или используйте для диагностики проблемы.

## Что включает файл

### 1. Системная информация (`system`)
- Дата экспорта
- URL сайта
- Версия PHP
- Версия WordPress
- Версия WooCommerce
- Версия плагина
- Лимиты памяти и времени выполнения
- Максимальный размер загружаемых файлов

### 2. Настройки плагина (`plugin_settings`)
- Включение/выключение экспорта категорий, товаров, основных объявлений
- Отключение категорий с одним товаром
- Контактные данные (телефон, метод связи, имя менеджера, адрес)
- Дополнительные поля (интернет-звонки, координаты, логотип, время работы)
- Настройки расписания (включено, интервал)
- Настройки логирования и уведомлений

### 3. Товары для экспорта (`products_for_export`)
- Общее количество товаров с `avito_export = yes`
- Подробная информация по каждому товару:
  - ID, название, артикул (SKU)
  - Тип товара (simple, variable, etc.)
  - Статус (publish, draft, etc.)
  - Цены (обычная, распродажная, текущая)
  - Категории товара
  - Все meta-поля Avito:
    - `avito_export`
    - `avito_title`
    - `avito_description`
    - `avito_specialty`
    - `short_avalible`
    - `deposit_amount`
  - Для вариативных товаров: минимальная и максимальная цена

### 4. Категории (`categories`)
- Общее количество категорий
- Подробная информация по каждой категории:
  - ID, название, slug
  - Количество товаров в категории
  - Все meta-поля Avito:
    - `avito_export`
    - `avito_category`
    - `avito_price`
    - `avito_contact_method`
    - `avito_manager_name`
    - `avito_contact_phone`
    - `avito_address`
    - `avito_internet_calls`

### 5. Информация о Cron задачах (`cron_info`)
- Статус XML генерации (включено/выключено)
- Расписание генерации
- Время следующего запуска
- Время последнего успешного запуска

### 6. Логи (`logs`)
- Последние 50 записей логов
- Каждая запись содержит:
  - Временную метку
  - Уровень (info, warning, error)
  - Сообщение

### 7. Текущие ошибки (`current_errors`)
- Список всех ошибок, возникших в текущей сессии

### 8. Информация о файлах (`files`)
- Существует ли XML файл
- Размер XML файла (в байтах)
- Дата последней модификации XML файла
- Путь к директории загрузок
- URL директории загрузок

### 9. Спецификация мета-полей (`meta_fields_specification`)

#### Мета-поля товаров (`product_meta_fields`)
Для каждого поля указывается:
- **Тип поля** (checkbox, text, textarea, select, number, url)
- **Название** (label)
- **Обязательность** (required)
- **Возможные значения** (для select и checkbox)
- **Описание** и назначение
- **Дополнительные ограничения** (max_length, format, default)

Список полей товаров:
- `avito_export` - включение экспорта (обязательное)
- `avito_title` - пользовательское название (до 50 символов)
- `avito_description` - описание (до 3000 символов)
- `avito_specialty` - категория инструмента
- `short_avalible` - доступность аренды на 3 часа
- `deposit_amount` - размер залога

#### Мета-поля категорий (`category_meta_fields`)
Список всех полей категорий с их параметрами:
- `avito_export` - включение экспорта категории
- `avito_category` - категория на Avito (12 вариантов)
- `avito_price` - цена для категории
- `avito_contact_method` - способ связи
- `avito_manager_name` - имя менеджера
- `avito_contact_phone` - телефон (формат +7XXXXXXXXXX)
- `avito_address` - адрес
- `avito_internet_calls` - интернет-звонки
- `avito_work_format` - формат работы
- `avito_experience` - опыт работы
- `avito_portfolio` - ссылка на портфолио
- `avitoid` - идентификатор для XML

#### Логика расчета цен (`price_calculation_logic`)
Документирует все формулы расчета цен:
- **price_3hours** - базовая цена (из товара или минимальная для вариативных)
- **daily_price** - цена за сутки (price_3hours × 2)
- **price_7days** - при аренде от 7 дней (daily_price × 0.8, скидка 20%)
- **price_30days** - при аренде от 30 дней (daily_price × 0.6, скидка 40%)
- **deposit** - залог (deposit_amount или price × 10)

#### Логика fallback (`fallback_logic`)
Порядок приоритета для получения значений настроек:
1. Значение из мета-поля конкретного товара/категории
2. Значение из мета-поля категории товара (только для товаров)
3. Значение из общих настроек плагина
4. Значение по умолчанию

Применяется к полям: contact_method, manager_name, contact_phone, address, internet_calls, avito_category

## Формат данных

Файл экспортируется в формате JSON с:
- `JSON_PRETTY_PRINT` - для читаемого форматирования
- `JSON_UNESCAPED_UNICODE` - для корректного отображения кириллицы
- `JSON_UNESCAPED_SLASHES` - для корректного отображения URL

## Пример структуры JSON

```json
{
  "system": {
    "export_date": "2025-11-13 15:30:45",
    "site_url": "https://example.com",
    "php_version": "8.1.0",
    "wordpress_version": "6.4.0",
    "woocommerce_version": "8.3.0",
    "plugin_version": "1.0.0",
    "memory_limit": "256M",
    "max_execution_time": "300",
    "upload_max_filesize": "64M"
  },
  "plugin_settings": {
    "enable_categories": "1",
    "enable_products": "1",
    "enable_main_ad": "1",
    "contact_phone": "+79123456789",
    ...
  },
  "products_for_export": {
    "total_count": 15,
    "products": [
      {
        "id": 123,
        "name": "Перфоратор",
        "sku": "PERF-001",
        "type": "simple",
        "price": "500",
        "categories": [
          {
            "id": 45,
            "name": "Электроинструменты",
            "slug": "elektroinstrumenty"
          }
        ],
        "meta_fields": {
          "avito_export": "yes",
          "avito_title": "Перфоратор в аренду",
          ...
        }
      }
    ]
  },
  "categories": { ... },
  "cron_info": { ... },
  "logs": [ ... ],
  "current_errors": [ ... ],
  "files": { ... },
  "meta_fields_specification": {
    "product_meta_fields": {
      "avito_export": {
        "type": "checkbox",
        "label": "Экспортировать на Avito",
        "values": ["yes", "no"],
        "required": true,
        "description": "Определяет, будет ли товар экспортироваться в XML"
      },
      "avito_title": {
        "type": "text",
        "label": "Пользовательское название для Avito",
        "required": false,
        "description": "Если не указано, используется название товара + \" – аренда\"",
        "max_length": 50
      }
      ...
    },
    "category_meta_fields": { ... },
    "price_calculation_logic": {
      "price_3hours": {
        "source": "product.get_price() или get_variation_price(\"min\") для вариативных",
        "description": "Базовая цена за 3 часа аренды",
        "default_if_empty": 50
      },
      "daily_price": {
        "formula": "price_3hours × 2",
        "description": "Цена за сутки",
        "default_if_empty": 100
      }
      ...
    },
    "fallback_logic": {
      "description": "Порядок приоритета значений настроек",
      "priority": {
        "1": "Значение из мета-поля конкретного товара/категории",
        "2": "Значение из мета-поля категории товара (для товаров)",
        "3": "Значение из общих настроек плагина",
        "4": "Значение по умолчанию"
      }
    }
  }
}
```

## Безопасность

⚠️ **ВАЖНО**: Экспортируемый файл содержит:
- Контактные данные (телефон, адрес)
- Структуру товаров и цены
- Системную информацию о сервере

**Не публикуйте этот файл в открытом доступе!** Отправляйте его только доверенным лицам для диагностики проблем.

⚠️ **ВАЖНО**: После использования файла для диагностики:
- Удалите файл из папки `wp-content/uploads/`
- Или используйте плагины для защиты доступа к директории uploads
- Файл доступен по прямой ссылке всем, кто знает его название

## Использование для диагностики

### Частые проблемы, которые можно выявить:

1. **Нет товаров в экспорте**
   - Проверьте `products_for_export.total_count`
   - Убедитесь, что у товаров стоит `avito_export = "yes"`

2. **Неправильные цены**
   - Проверьте `price`, `regular_price`, `sale_price` у товаров
   - Для вариативных товаров проверьте `variation_price_min` и `variation_price_max`

3. **Проблемы с расписанием**
   - Проверьте `cron_info.xml.enabled`
   - Проверьте `cron_info.xml.next_run` и `cron_info.xml.schedule`

4. **Ошибки генерации**
   - Проверьте `logs` на наличие записей с уровнем `error`
   - Проверьте `current_errors`

5. **Проблемы с настройками**
   - Проверьте все значения в `plugin_settings`
   - Убедитесь, что контактные данные заполнены

6. **Проверка корректности мета-полей**
   - Используйте `meta_fields_specification` для понимания всех доступных полей
   - Сравните фактические значения в `products_for_export.products[].meta_fields` со спецификацией
   - Проверьте, что обязательные поля заполнены (`avito_export` для товаров)
   - Убедитесь, что значения select-полей соответствуют допустимым вариантам

7. **Проверка логики расчета цен**
   - Используйте `price_calculation_logic` для понимания формул
   - Проверьте, что базовые цены товаров корректны
   - Для вариативных товаров проверьте `variation_price_min` и `variation_price_max`

8. **Проверка fallback логики**
   - Используйте `fallback_logic` для понимания приоритетов
   - Если поле не заполнено на уровне товара, проверьте категорию
   - Если не заполнено на уровне категории, проверьте `plugin_settings`

## Обновления

### Версия 1.3 - 13 ноября 2025
- ✅ **ОПТИМИЗАЦИЯ**: Размер файла уменьшен на 60-70% за счет исключения пустых полей
- ✅ Товары: включаются только непустые мета-поля, SKU, цены и статус
- ✅ Категории: удален slug, включаются только непустые мета-поля и count > 0
- ✅ Настройки: контактные данные включаются только если заполнены
- ✅ Вариативные товары: цены min/max только если отличаются

### Версия 1.2 - 13 ноября 2025
- ✅ **ИСПРАВЛЕНО**: Файл теперь сохраняется в `wp-content/uploads/` вместо прямой отправки через headers
- ✅ Добавлена кнопка для скачивания файла в интерфейсе
- ✅ Добавлена запись в логи при создании файла
- ✅ Обновлены инструкции по безопасности
- ✅ Добавлено предупреждение об удалении файла после использования

### Версия 1.1 - 13 ноября 2025
- ✅ Добавлена секция **meta_fields_specification**
- ✅ Полная документация всех мета-полей товаров и категорий
- ✅ Описание логики расчета цен
- ✅ Документация fallback логики
- ✅ Примеры использования для диагностики

### Версия 1.0 - 13 ноября 2025
- ✅ Первоначальная версия функции экспорта
